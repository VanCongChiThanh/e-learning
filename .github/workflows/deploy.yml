name: CI/CD Docker to EC2

on:
  push:
    branches: [ main ]

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      # Chỉ chạy unit test (bỏ Integration Test nếu có)
      - name: Run unit tests
        run: mvn -B -ntp test -DskipITs=true

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: |
            **/target/surefire-reports/**
            **/target/failsafe-reports/**

  build-and-deploy:
    name: Build & Deploy (App only, keep Caddy)
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up JDK 17 (cache maven)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      - name: Build Maven project (package, skip tests for speed)
        run: mvn -B -ntp clean package -DskipTests

      - name: Build Docker image
        run: docker build -t e-learning:latest .

      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Push Docker image
        run: |
          docker tag e-learning:latest ${{ secrets.DOCKER_USERNAME }}/e-learning:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/e-learning:latest

      # Chỉ deploy app, KHÔNG đụng tới Caddy
      - name: Deploy app on EC2 (keep Caddy running)
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -Eeuo pipefail
            IMAGE="${{ secrets.DOCKER_USERNAME }}/e-learning:latest"
            DOMAIN="api-coursevo-dev.id.vn"

            echo "==> Ensure docker network"
            docker network create web || true

            echo "==> Pull image"
            docker pull "$IMAGE"

            echo "==> Stop/remove old app"
            docker stop e-learning || true
            docker rm e-learning || true

            echo "==> Run app (NO port publish, only network web)"
            docker run -d --name e-learning \
              --network web \
              -e SERVER_FORWARD_HEADERS_STRATEGY=native \
              -e SERVER_PORT=8105 \
              -e DB_USERNAME="${{ secrets.DB_USERNAME }}" \
              -e DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
              -e DB_URL="${{ secrets.DB_URL }}" \
              -e EMAIL_USERNAME="${{ secrets.EMAIL_USERNAME }}" \
              -e EMAIL_PASSWORD="${{ secrets.EMAIL_PASSWORD }}" \
              -e GOOGLE_CLIENT_ID="${{ secrets.GOOGLE_CLIENT_ID }}" \
              -e GOOGLE_CLIENT_SECRET="${{ secrets.GOOGLE_CLIENT_SECRET }}" \
              -e FACEBOOK_CLIENT_ID="${{ secrets.FACEBOOK_CLIENT_ID }}" \
              -e FACEBOOK_CLIENT_SECRET="${{ secrets.FACEBOOK_CLIENT_SECRET }}" \
              -e AWS_ACCESS_KEY="${{ secrets.AWS_ACCESS_KEY }}" \
              -e AWS_SECRET_KEY="${{ secrets.AWS_SECRET_KEY }}" \
              -e TOKEN_SECRET="${{ secrets.TOKEN_SECRET }}" \
              -e REFRESH_TOKEN_SECRET="${{ secrets.REFRESH_TOKEN_SECRET }}" \
              -e PAYOS_CLIENT_ID="${{ secrets.PAYOS_CLIENT_ID }}" \
              -e PAYOS_API_KEY="${{ secrets.PAYOS_API_KEY }}" \
              -e PAYOS_CHECKSUM_KEY="${{ secrets.PAYOS_CHECKSUM_KEY }}" \
              -e PAYOS_PARTNER_CODE="${{ secrets.PAYOS_PARTNER_CODE }}" \
              -e PAYOS_SANDBOX="${{ secrets.PAYOS_SANDBOX }}" \
              -e PAYOS_DEFAULT_EXPIRATION="${{ secrets.PAYOS_DEFAULT_EXPIRATION }}" \
              -e PAYOS_RETURN_URL="${{ secrets.PAYOS_RETURN_URL }}" \
              -e PAYOS_CANCEL_URL="${{ secrets.PAYOS_CANCEL_URL }}" \
              -e PAYOS_WEBHOOK_URL="${{ secrets.PAYOS_WEBHOOK_URL }}" \
              -v /home/ubuntu/firebase-service-account.json:/app/firebase-service-account.json \
              --restart unless-stopped \
              "$IMAGE"

            echo "==> (1) Internal warm-up via Caddy container network"
            # Đợi backend mở cổng nội bộ trước khi check HTTPS ngoài
            ATTEMPTS=120
            SLEEP=2
            until docker exec caddy sh -lc \
              'wget -qS -O- http://e-learning:8105/api >/dev/null 2>&1 || wget -qS -O- http://e-learning:8105/ >/dev/null 2>&1'; do
              ATTEMPTS=$((ATTEMPTS-1))
              [ $ATTEMPTS -le 0 ] && { echo "Backend never became ready internally"; exit 1; }
              sleep $SLEEP
              [ $SLEEP -lt 5 ] && SLEEP=$((SLEEP+1))
            done
            echo "Backend is ready internally."

            echo "==> (2) External HTTPS check (accept 200/301/302/401/403/404)"
            ATTEMPTS=90
            SLEEP=2
            until code=$(curl -k -s -o /dev/null -w "%{http_code}" "https://${DOMAIN}/api"); \
                  [ "$code" -eq 200 ] || [ "$code" -eq 301 ] || [ "$code" -eq 302 ] || \
                  [ "$code" -eq 401 ] || [ "$code" -eq 403 ] || [ "$code" -eq 404 ]; do
              ATTEMPTS=$((ATTEMPTS-1))
              [ $ATTEMPTS -le 0 ] && { echo "External health failed, last HTTP $code"; exit 1; }
              sleep $SLEEP
            done
            echo "Healthy: HTTP ${code}"